name: Matrix WARN Scraper with Slack Alerts

on:
  schedule:
    - cron: '0 15 * * *' # 10:00 AM EST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    name: Scrape
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        # TEST TIP: Use [ca, ny, ia] for your first run
        state: [ny, ia]
        # state: [al, ak, az, ar, ca, co, ct, de, fl, ga, hi, id, il, in, ia, ks, ky, la, me, md, ma, mi, mn, ms, mo, mt, ne, nv, nh, nj, nm, ny, nc, nd, oh, ok, or, pa, ri, sc, sd, tn, tx, ut, vt, va, wa, wv, wi, wy]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install scraper
        run: pip install warn-scraper

      - name: Scrape
        run: |
          mkdir -p ./data/
          python -c "from warn.cli import main; import sys; sys.argv=['warn-scraper', '${{ matrix.state }}', '--data-dir', './data/']; main()"

      - name: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.state }}
          path: ./data/${{ matrix.state }}.csv

  commit:
    name: Commit and Alert
    runs-on: ubuntu-latest
    needs: scrape
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Necessary to compare today's data with yesterday's

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: pip install pandas requests

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          path: artifacts/

      - name: Move and Prepare
        run: |
          mkdir -p data
          # We store the 'old' version of the files before overwriting them
          mkdir -p old_data
          cp data/*.csv old_data/ 2>/dev/null || true
          mv artifacts/**/*.csv data/

      - name: Create Rolling 30-Day Window
        shell: python
        run: |
          import pandas as pd
          import glob
          from datetime import datetime, timedelta
          threshold = datetime.now() - timedelta(days=30)
          all_dfs = []
          for f in glob.glob("./data/*.csv"):
              if "recent_notices.csv" in f: continue
              try:
                  df = pd.read_csv(f)
                  d_col = next((c for c in df.columns if 'date' in c.lower()), None)
                  if d_col:
                      df[d_col] = pd.to_datetime(df[d_col], errors='coerce')
                      all_dfs.append(df[df[d_col] >= threshold])
              except: continue
          if all_dfs:
              pd.concat(all_dfs).sort_values(by=d_col, ascending=False).to_csv("./data/recent_notices.csv", index=False)


      - name: Send Slack Alerts
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        shell: python
        run: |
          import pandas as pd
          import requests
          import os
          import glob

          webhook_url = os.environ.get('SLACK_WEBHOOK_URL')
          
          # Mapping states to their official WARN portals
          URL_MAP = {
              "NY": "https://dol.ny.gov/warn-notices",
              "CA": "https://edd.ca.gov/en/Jobs_and_Training/Layoff_Services_WARN",
              "IA": "https://www.iowaworkforcedevelopment.gov/worker-adjustment-and-retraining-notification-warn-notices",
              "TX": "https://www.twc.texas.gov/biz/warn/warn-notices.html",
              "FL": "https://reactweb.floridajobs.org/Warnnotices/Search"
              # Add other states here as needed
          }

          for new_file in glob.glob("./data/*.csv"):
              if "recent_notices.csv" in new_file: continue
              
              state_code = os.path.basename(new_file).replace('.csv', '').upper()
              old_file = new_file.replace('./data/', './old_data/')
              state_url = URL_MAP.get(state_code, "https://www.google.com/search?q=" + state_code + "+WARN+notices")
              
              try:
                  df_new = pd.read_csv(new_file)
                  
                  if os.path.exists(old_file):
                      df_old = pd.read_csv(old_file)
                      # Identify truly new records
                      merged = df_new.merge(df_old, how='outer', indicator=True)
                      new_records = merged[merged['_merge'] == 'left_only'].drop('_merge', axis=1)
                  else:
                      new_records = df_new.head(1) # Alert on just 1 for a brand new state

                  print(f"Found {len(new_records)} new records for {state_code}")

                  for _, row in new_records.iterrows():
                      co = next((row[c] for c in df_new.columns if 'company' in c.lower()), "Unknown Company")
                      jobs = next((row[c] for c in df_new.columns if 'job' in c.lower() or 'worker' in c.lower() or 'count' in c.lower()), "N/A")
                      date = next((row[c] for c in df_new.columns if 'date' in c.lower()), "N/A")
                      
                      # Formatting the Slack message with a "View Official Page" button link
                      payload = {
                          "blocks": [
                              {
                                  "type": "section",
                                  "text": {
                                      "type": "mrkdwn",
                                      "text": f"ðŸš¨ *New WARN Notice: {state_code}*\n*Company:* {co}\n*Jobs affected:* {jobs}\n*Notice Date:* {date}"
                                  }
                              },
                              {
                                  "type": "actions",
                                  "elements": [
                                      {
                                          "type": "button",
                                          "text": {
                                              "type": "plain_text",
                                              "text": "ðŸ”— View Official State Page"
                                          },
                                          "url": state_url
                                      }
                                  ]
                              }
                          ]
                      }
                      requests.post(webhook_url, json=payload)
              except Exception as e:
                  print(f"Error processing {state_code}: {e}")

      - name: Save datestamp
        run: date > ./data/latest-scrape.txt

      - name: Update Index Page
        shell: python
        run: |
          import glob
          import os
          from datetime import datetime

          # Same URL map used in Slack for consistency
          URL_MAP = {
              "NY": "https://dol.ny.gov/warn-notices",
              "CA": "https://edd.ca.gov/en/Jobs_and_Training/Layoff_Services_WARN",
              "IA": "https://www.iowaworkforcedevelopment.gov/worker-adjustment-and-retraining-notification-warn-notices",
              "TX": "https://www.twc.texas.gov/biz/warn/warn-notices.html"
          }

          content = "# ðŸ“¢ WARN Act Data Portal\n\n"
          content += "Automated tracking of layoff notices across the U.S. Updated daily at 10:00 AM EST.\n\n"
          content += "### ðŸ•’ Latest Global Update: " + datetime.now().strftime("%Y-%m-%d %H:%M") + " UTC\n\n"
          content += "| State | Data Download | Official Source |\n"
          content += "| :--- | :--- | :--- |\n"
          content += "| **All States** | [Download Combined 30-Day CSV](./data/recent_notices.csv) | - |\n"

          # Loop through state files to build the table
          for f in sorted(glob.glob("./data/*.csv")):
              if "recent_notices" in f: continue
              state = os.path.basename(f).replace('.csv', '').upper()
              source = URL_MAP.get(state, "Search Google")
              content += f"| {state} | [Download CSV](./data/{state.lower()}.csv) | [Link]({source}) |\n"

          content += "\n\n---\n*This page is automatically updated by GitHub Actions.*"

          with open("README.md", "w") as f:
              f.write(content)


      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git add ./data/
          git commit -m "Update WARN data and recent_notices" && git push || true
